# Transform Pipeline DICOM Metadata Values and Schema

## Purpose

Metadata is required for the Digital Pathology Transformation pipeline to
convert whole slide imaging into DICOM. Metadata is required to enable imaging
to be recalled following successful ingestion. This document describes how to
configure metadata input for the Digital Pathology Transform Pipeline.

## Overview

The Digital Pathology Transformation Pipeline enables customer defined metadata
to be merged with the Digital Imaging and Communications in Medicine (DICOM)
instances generated by the pipeline. In brief, DICOM metadata  describes imaging
to enable humans and computer systems to recall imaging and interpret imaging.
DICOM metadata is designed to capture high-level concepts (_e.g._, patient
information, sample preparation, diagnosis codes,_ etc._).
DICOM metadata is stored within DICOM instances in DICOM tags. Tags are
identified by address and/or keyword and stored within a DICOM instance in a
tree-like structure. The interpretation of a tag's value is defined by the
combination of the tag's identifying address/keyword and its position within the
metadata structure. The organization of tags within a DICOM is defined by the
DICOM Information Object Definition (IOD). Whole slide digital pathology imaging
is represented in DICOM using the
[VL Whole Slide Microscopy Image IOD](https://dicom.nema.org/medical/Dicom/2017c/output/chtml/part03/sect_A.32.8.html).
DICOM metadata can be retrieved from the
[DICOM store using DICOMweb](https://cloud.google.com/healthcare-api/docs/how-tos/dicomweb).
The DICOM store can be configured to automatically
[stream DICOM metadata to Big Query](https://cloud.google.com/healthcare-api/docs/how-tos/dicom-bigquery-streaming)
to enable advanced data analytics use cases. It is recommended that metadata be
defined as richly as possible. At a minimum, the Transformation Pipeline
requires that all slides define metadata values that define a slide's "Primary
Metadata Key Value" and "Study Instance UID".

The process that the Transformation pipeline uses to identify the primary
metadata key of an image is described in reference [1].

## Minimally Required Metadata for Ingestion and Image retrieval

A minimal set of metadata is required for: 1) Transformation Pipeline Execution;
2) Post ingestion image search and retrieval; and 3) DICOM Conformance. The
DICOM tags discussed in this section are discussed in greater detail in the [CSV
required slide metadata value] section. An example of a
minimalistic DICOM metadata value table is shown in Appendix [1].

1. **Metadata Requirements for Transform Pipeline Execution**

  The Transformation Pipeline requires that all slides have metadata definitions
  that identify the slides primary metadata key value and with one exception, the
  Study Instance UID or Accession Number.

2. **Metadata Requirements for Image Retrieval**

  DICOM imaging can be accessed directly by UID. However, for many use
  cases images are retrieved from the store by performing searches against
  specific DICOM tags. The Google DICOM store supports search against a set
  of DICOM tags. To facilitate image identification post ingestion it is
  highly recommended that at least some of the searchable tags are defined.
  These tags are listed in the **[Additional Highly Recommended Metadata Using Default Schemas Table]**.
  The AccessionNumber tag is used by the view to search for studies.

3. **Metadata Requirements for DICOM Conformance**

  The DICOM Standard requires that Type 1 metadata fields have defined values.
  Specifically, the VL Whole Slide Microscopy Image IOD requires the definition of
  **[ContainerIdentifier, SpecimenIdentifier,  and SpecimenUID]**
  It is recommended that the Slide ID, unique identifier for the physical glass
  slide be stored in the ContainerIdentifier tag. The Google DICOM store does not
  enforce DICOM conformance. However, failure to generate conformant DICOM may
  impede interoperability with other systems.

## Transformation Pipeline Metadata Inputs

The transformation pipeline requires two metadata inputs; 1) a metadata value
mapping table which defines the values that will be written in a slide's DICOM
instances; and 2) a **[metadata mapping schema]** which
defines the the position within the DICOM structure that metadata values are
written. The slide metadata value table is represented as a Big Query Table
(Recommended) or one or more CSV file(s). The metadata mapping schema is defined
once per-DICOM IOD using JSON formatted files. Big Query metadata is read from
the Big Query table or table view defined by the transformation pipeline
`BIG_QUERY_METADATA_TABLE` environmental variable. Metadata inputs, JSON and CSV
(if used), are read from the metadata input bucket when changes to the metadata
are detected. The Transformation Pipeline IaC code will create the metadata
ingestion bucket and place example/starter metadata mapping schemas (*.JSON
files) in the ingestion bucket. Default metadata value input big query table or 
(*.CSV files) are not provided. These must be created to use the transformation
pipeline.

### Slide Metadata Value Table Format:

#### BigQuery Table/Table View Configuration and Format

The Transformation Pipeline supports parsing metadata from Big Query. To
configure the pipeline to read from Big Query, the environmental variable
`BIG_QUERY_METADATA_TABLE `should be set to the Big Query table id or view id
(ie. project_id.dataset_id.table_id or project_id.dataset_id.view_id) of the
BigQuery metadata table that contains slide metadata. The transformation
pipeline service account is required to have read/write IAM privileges for the
bigquery metadata table or table view. Column header names are expected to be
unique within the table ignoring character case, and when spaces and ‘_'
characters are ignored. The table column schema should define the columns as
containing string values and columns can be defined as optional, nullable, where
appropriate.

#### CSV Table File Format

CSV files may contain comment lines at the start of the file; lines prefixed
with the # character. Following comments, the file is expected to contain a
table header row that identifies the names of the columns defined within the
file's table. Column header names are expected to be unique within the table
ignoring character case, and when spaces and ‘_' characters are ignored.
Following the header each row in the file defines the metadata values for a
slide. All of the metadata values for a slide should be expressed on a single
row in the file. All columns must be defined. Column values may be omitted from
a slide's metadata by leaving a column metadata entry empty.

#### Metadata Value Formatting (Big Query Table/View and CSV Tables)

Metadata values are expected to be formatted in both the Big Query Tables and
CSV Tables as defined by DICOM tag(s)
[VR code](https://dicom.nema.org/medical/dicom/current/output/chtml/part05/sect_6.2.html)
that the metadata is written into (see DICOM schema). Failure to correctly
format the tags will result in the generation of DICOM which is not DICOM
Standards compliant. It is recommended that metadata values exclude the
[backslash ("\")](https://dicom.nema.org/dicom/2013/output/chtml/part05/sect_6.2.html)
character. This character is used by the DICOM standard to break string values
into arrays.

### Required Slide Metadata Table Columns

All slides are required to define a metadata primary key column and provide
sufficient metadata for the transformation pipeline to determine a DICOM Study
Instance UID for the transformed imaging.

#### Metadata Primary Key

Imaging ingested by the transformation pipeline is joined with metadata by
identifying a primary key on the imaging that corresponds with a value in the
Metadata Primary Key Column. The pipeline requires that all ingested imaging
have an identifiable metadata primary key. The column used as the metadata
primary key is defined in the environmental variable
METADATA_PRIMARY_KEY_COLUMN_NAME; default value "Bar Code Value".

#### Study Instance UID (Required*)

Each slide is required to define Study Instance UID metadata or configure the
pipeline to auto-generate Study Instance UID (see following paragraph). If
defined in metadata,  Study Instance UID metadata must be formatted as described
by the DICOM Standard (See
["UI" VR Code formatting](https://dicom.nema.org/medical/dicom/current/output/chtml/part05/sect_6.2.html)).
It is encouraged that slides acquired at the same clinical exam share the same
Study Instance UID. Study Instance UID should not be shared across patients or
across exams. * There is one case where Study Instance UID are not required to
be defined in metadata. If DICOM imaging is being ingested and the
Transformation pipeline is configured to use the StudyInstanceUID value stored
in the DICOM instance. This is enabled by setting the transformation pipeline
environmental variable, GCS_INGEST_STUDY_INSTANCE_UID_SOURCE = DICOM.

The pipeline can be configured to auto-generate Study Instance UID. To generate
Study Instance UID the slide metadata is required to define the Accession Number
and optionally the Patient ID. The Accession Number is expected to be unique to
the Study Instance UID. The Patient ID is not expected to be unique to the Study
Instance UID. In brief, to generate missing Study Instance UID the pipeline will
first search the DICOM store for studies that contain the Accession Number and
optionally PatientID. If a UID is found, the UID will be used, if no UID is
found a new Study Instance UID will be generated. To enable Study UID auto
generation set the environmental variable
`ENABLE_CREATE_MISSING_STUDY_INSTANCE_UID value` to True.

#### Additional Highly Recommended Metadata Using Default Schemas

<table>
  <thead>
    <tr>
      <th><strong>Metadata Column Name</strong></th>
      <th>DICOM Tag</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Case ID</strong></td>
      <td>AccessionNumber</td>
      <td>DICOMweb searchable text metadata value. The metadata value for the
Accession number is expected have a 1-to-1 mapping with the Study
Instance UID. Pipeline can be configured to auto-generate the Study
Instance UID using this metadata field as input. The metadata value
for the Accession Number should not exceed 16 characters.</td>
    </tr>
    <tr>
      <td><strong>SpecimenCollectionDate</strong></td>
      <td>StudyDate</td>
      <td>DICOMweb searchable metadata value. Should be the same for all slides
with the same Study Instance UID.</td>
    </tr>
    <tr>
      <td><strong>Patient Name</strong></td>
      <td>Patient Name</td>
      <td>DICOMweb searchable text metadata value. Should be the same for all
slides with the same Study Instance UID.</td>
    </tr>
    <tr>
      <td><strong>Patient ID</strong></td>
      <td>Patient ID</td>
      <td>DICOMweb searchable text metadata value. Should be the same for all
slides with the same Study Instance UID.</td>
    </tr>
    <tr>
      <td><strong>Requesting Physician</strong></td>
      <td>ReferringPhysicianName</td>
      <td>DICOMweb searchable text metadata value. Should be the same for all
slides with the same Study Instance UID. For non-clinical research
use cases replace with the name of laboratory or requesting
scientist.</td>
    </tr>
    <tr>
      <td><strong>Slide ID</strong></td>
      <td>ContainerIdentifier</td>
      <td>Type 1 Tag; Required for DICOM Conformance; Unique identifier for the
glass slide.</td>
    </tr>
    <tr>
      <td><strong>Material ID</strong></td>
      <td>SpecimenIdentifier</td>
      <td>Type 1 Tag; Required for DICOM Conformance; Clinic or lab identifier
for a specimen (conceptually map to tissue block).</td>
    </tr>
    <tr>
      <td><strong>Specimen UID</strong></td>
      <td>SpecimenUID</td>
      <td>Type 1 Tag; Required for DICOM Conformance; DICOM UID for the
specimen (conceptually map to tissue block).</td>
    </tr>
  </tbody>
</table>

### Example CSV Metadata

# Example CSV Metadata defining a single slide with metadata defined for values
for columns:
\#   Barcode Value=GO-1692728854149-1-A-0
\#
StudyInstanceUID=1.3.6.1.4.1.11129.5.7.999.18649109954048068.379.1692728854155071
\#   Patient Name=Last^First
\#   Patient ID= PN-1-692-728-854-149-1
\#   Specimen Collection Date=20230612
\#   CaseID=GO-1692728854149-1
Barcode Value, Study Instance UID, Patient Name, Patient ID, Specimen Collection
Date, Case ID
GO-1692728854149-1-A-0,
1.3.6.1.4.1.11129.5.7.999.18649109954048068.379.1692728854155071, Last^First,
PN-1-692-728-854-149-1, 20230612, GO-1692728854149-1

#### Recommendations

-  Preferentially define Metadata values in BigQuery Table instead of CSV
    files.

##### CSV File Metadata Recommendations

-  CSV Metadata files should describe the metadata for large blocks of
    slides, e.g., all slides to be ingested over the next day.
-  CSV Metadata files should be added to the bucket infrequently, e.g., once
    or twice a day.
-  CSV Metadata files which are obsolete should be removed from the metadata
    ingestion bucket. It is recommended that this operation be conducted at
    most once per week.

> Basis for above recommendations: Transformation pipeline caches slide
metadata to speed ingestion. Altering metadata invalidates the slide
metadata cache and triggers a cache update. Removing unnecessary data from
the cache will reduce the total size of the data retrieved from the cache
during cache update.

**Metadata Mapping Schema (JSON File) Format:**
The position within a DICOM instance's structure that metadata values are mapped
to is defined by a [metadata mapping schema]. Metadata
mapping schemas are DICOM IOD specific. DICOM IODs define DICOM document model
requirements; (e.g., VL Whole Slide Microscopy Image IOD defines the metadata
requirements for most digital pathology images).
By default the transformation pipeline IaC installs metadata mapping schemas in
the pipelines metadata ingestion bucket for the following three digital
pathology DICOM IODs:

1. VL Whole Slide Microscopy Image IOD
2. VL Microscopic Image IOD
3. VL Slide-Coordinates Microscopic Image IOD. These metadata mappings schemas
  should be modified as needed.

### Metadata Mapping Schema File Structure

The mapping schema structure directly models the metadata structure it creates
when transforming metadata to DICOM. Schemas are formatted as JSON documents.
The root level dictionary contains a DICOMSchemaDefinition key entry. This entry
identifies the DICOM IOD that is defined by the schema.  For readability the
SOPClassUID are written out as text and not UID. All other tags in this or other
dictionaries within the schema define metadata mapping for DICOM tags.

Example Metadata Schema Fragment defining VL Whole slide Image IOD schema

```
{ "DICOMSchemaDef":{
  "SOPClassUID_Name": "VL Whole Slide Microscopy Image Storage"
  },
  [One or more DICOM Tag definitions follow]
}
```

#### DICOM Tag Specification

The DICOM standard defines a unique address and associated keyword for each tag.
 Addresses are commonly expressed as a 32 bit hexadecimal value.  Keywords are
camelcase strings, free from whitespace and punctuation. All tags defined by the
schema are defined by address and keyword. Enabling the Transformation Pipeline
to validate that the address and keyword resolve to the same DICOM tag.

Example PatientName Tag defined at root level of VL Whole slide Image IOD
schema

```
{ "DICOMSchemaDef":{
  "SOPClassUID_Name": "VL Whole Slide Microscopy Image Storage"
  },
  "0x00100010": {
     "Keyword": "PatientName",
  [Tag value definition follows]
  }
}
```

The mapping schema provides three mechanisms to join values with tags; static
value mapping, metadata value mapping, and a metadata join mapping.

##### Mapping Static Values to Tags

Static value mapping maps a static value defined within the schema to a tag's
metadata value.
In the example, the DICOM tag "ValueType" is assigned the value "TEXT" which is
expressed directly within the schema. Static tags are particularly useful when
combined with a conditional operator and can be used to express supplemental
metadata which is required if another tag within the schema is set.

Example:

```
"0x0040A040": {
  "Keyword": "ValueType",
  "Static_Value": "TEXT"
},
```

##### Metadata Values

Metadata value mapping sets a DICOM tag's value to the value stored in the slide
metadata value mapping table. The column containing the metadata value is
identified by name in the schema by assigning the Tag's Schema "Meta" key to the
desired column's header text. In the example below the value stored in the
Patient Name tag is being set from the column named "Patient Name" in the
Metadata value table. The row in the table used is the one identified by joining
the imaging barcode value with the metadata table barcode value.

Example:

```
"0x00100010": {
  "Keyword": "PatientName",
  "Meta": "Patient Name"
},
```

##### Metadata Value Joins

The values of multiple columns can be combined together to create complex
multi-component metadata values. The metadata mapping the Meta keyword is
assigned to a list of metadata value column names. The values stored in the
column names are joined together using a defined string. In the example below,
the values stored in the metadata columns "Test ID" and "Test Name" are joined
using the string "-".

Example:

```
"0x00081030": {
  "Keyword": "StudyDescription",
  "Meta": ["Test ID", "Test Name"],
  "Meta_Join": "-"
},
```

##### Metadata Conditional Tags

The expression of tags defined within the metadata mapping schema can be made
conditional on the definition of a metadata column. For conditional to be true,
a value must be defined for the conditional metadata column in the metadata
table with a defined value and the conditional column value must be written to a
DICOM tag.  In the example below, if a slides metadata value table defines a
value for  `Material Type` then the TextValue and Value type tags would be
written. If MaterialType was not provided then neither tags would be written.

Example:

```
"0x0040A160" : {
  "Keyword": "TextValue",
  "Meta": "Material Type"
},
"0x0040A040": {
  "Keyword": "ValueType",
  "Static_Value": "TEXT",
  "Conditional_On": "Material Type"
},
```

##### Metadata Length Conditional Tags

The DICOM standard specifies that some tags should be selectively stored in tags
based on the length of the values that are to be stored within them. Conditional
value operators support the following operations: ==, <=, >=, <, >.  The
conditional value operator is defined by defining the key:
**VALUE_CHAR_LIMIT** as the conditional operation. Conditional operations
should be defined as a string, "{operation}{value}".  In the example below, the
schema defines two tags. The specific tag written to the DICOM depends on the
length of the value stored in a slides' `Material Type` metadata value column.
Slides with material type values <= 16 characters will write the value to a
DICOM Tag with the keyword "`CodeValue`" and slides with longer material type
tags will write to the "`LongCodeValue`" tag.

```
"0x00080100": {
  "Keyword": "CodeValue",
  "VALUE_CHAR_LIMIT": "<=16",
  "Meta": "Material Type"
},
"0x00080119": {
  "Keyword": "LongCodeValue",
  "VALUE_CHAR_LIMIT": ">16",
  "Meta": "Material Type"
},
```

##### Required Tags

The default behavior is that schema tags that define mappings for undefined
metadata are not written to the DICOM. The definition of metadata values for
Type 1 tags can be implicitly enabled by setting an environmental variable on
the transformation pipeline. Any tag, regardless of Type, can be made
non-optional by adding the "Required": "True" tag to the tag's schema
definition.  In the example below, Type PatientName is a Type 2 tag. By default
the failure to provide a definition for the Patient Name would not block
ingestion. However, adding the `"Required": "True"` to the Tag's schema
definition makes the tags definition required and will result in an ingestion
failure if the value was not provided in the metadata.

```
"0x00100010": {
  "Keyword": "PatientName",
  "Meta": "Patient Name"
  "Required": "True"
},
```

##### Write Empty

For most tags failure to define a non-required tag will result in the tag being
omitted from the DICOM instance. The DICOM standard requires that undefined Type
2 DICOM tags are written to the DICOM with NULL or empty values. The ingestion
mapping schema  provides this behavior. The WRITE_EMPTY key can be defined to
selectively enable this behavior on other tags. It is not recommended that this
setting be used on Type 1 tags. The DICOM standard specifies that Type 1 tags
must be defined with a meaningful value. In the example below, "Patient
Comments" a Type 3 tag would normally be omitted if undefined. Setting the Tag's
Schema to define "WRITE_EMPTY" : "TRUE" will result in the tag being written out
with an empty value if the tag's metadata is not provided.

```
"0x00104000": {
  "Keyword": "PatientComments",
  "Meta": "Comments"
  "Write_Empty": "True"
},
```

##### DICOM Sequences

DICOM sequences are DICOM tags which define lists of dictionaries of metadata.
As an example a sequence could define a list of steps used to prepare a
specimen. The metadata mapping schema enables metadata values to be mapped into
sequences of arbitrary position and depth.  The example below illustrates an
example definition for a `SpecimenDescriptionSequence` sequence.  The "SQ" key
on the tag contains a list of the dictionaries of DICOM tags. To be created, the
inner sequence dictionaries must have at least one tag with defined value. 

```
0x00400560": {
  "Keyword": "SpecimenDescriptionSequence",
  "SQ": [ DICTIONARY_1, DICTIONARY_2, … DICTIONARY_N ]
}
```

#### Validation and Expectations

Tag Value Length Validation
Many DICOM tag VR codes have defined length limitations for tag values. Tag
values found to exceed these limits will be clipped. A warning will be logged to
cloud operations when clipping is performed. It is recommended that metadata
values in accordance with the DICOM standard such that this feature is not
commonly used.

Require Type 1 Tag Metadata
The DICOM standard requires that all Type 1 tags be expressed with actual values
in a DICOM instance. Type 1 tag requirements are defined by the IOD. The
Transformation pipeline can be configured to require that the DICOM metadata
value table provides values for all Type 1 tags defined within a schema. To
enable this feature, the Transformation pipeline environmental variable
**REQUIRE_TYPE1_DICOM_TAG_METADATA_IS_DEFINED** should be set to **True.**
It is False by default.

Schema Validation
The DICOM tag position within the schema is validated against the DICOM IOD.
Schemas which define tag positions which are not described by the DICOM IOD will
log errors and block ingestion until fixed.

##### Expectations

All metadata values expressed within the DICOM metadata mapping table are
expected to be formatted using the DICOM VR code formatting requirements for the
tag that the metadata value will be mapped into.  Failure to correctly format
DICOM tags may result in DICOM which is not standard compliant.

The transformation pipeline does not validate that the DICOM tags defined by an
IOD are defined. It is up to the users of the transformation pipeline to
validate pipeline output.

## References

[1]
[Joining WSI Imaging with Metadata](https://github.com/GoogleCloudPlatform/medical-imaging/blob/main/pathology/transformation_pipeline/docs/joining_wsi_imaging_with_metadata.md)

## Appendix 1: Example of Metadata Value Table

Example of minimal metadata values compatible with default json mapping schemas.
Metadata value example describes three slides, first two maps into the same
Study Instance UID.

Barcode Value = Primary Key for matching metadata and barcode value of slide.
Unique for every slide.

Study Instance UID = DICOM Study Instance UID (DICOM formatting required)
defines groupings of slides acquired at the same exam from the same patient.
Case ID = Case identifier, free text identifier that has the same level of
clustering as the Study Instance UID.

Slide ID = Unique identifier for the glass slide.  Same value as barcode, maps
to a different DICOM tag. However, it could have a value different from Barcode
value if Barcode Value != SlideID.

Material ID = Free Text which identifies the specimen which is represented on
the slide, e.g., tissue block cut. (Could be omitted at the cost of DICOM
conformance)

Specimen UID = DICOM UID which identifies the Material ID. (Could be omitted
at the cost of DICOM conformance)

What mapping supports:

-  Basic ingestion (Defines Barcode Value and Slide ID)
-  DICOM Conformance (Defines: ContainerIdentifier,  SpecimenIdentifier,
    SpecimenUID)
-  DICOMweb search for case id and identification of slide in case by slide id.

**Barcode Value, Study Instance UID, Case ID,  Slide ID, Material ID, Specimen
UID**

GO-16-1-A1-1, 1.3.6.1.4.1.11129.5.7.999.1, GO-16-1, GO-16-1-A1-1, GO-16-1-A1,
1.3.6.1.4.1.11129.5.7.999.2

GO-16-1-A2-1, 1.3.6.1.4.1.11129.5.7.999.1, GO-16-1, GO-16-1-A2,-1 GO-16-1-A2,
1.3.6.1.4.1.11129.5.7.999.2

GO-32-1-A1-1, 1.3.6.1.4.1.11129.5.7.999.5, GO-32-1, GO-32-1-A1-1, GO-16-1-A1,
1.3.6.1.4.1.11129.5.7.999.6


<table>
  <thead>
    <tr>
      <th><strong>Metadata Column Name</strong></th>
      <th>DICOM Tag</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Case ID</strong></td>
      <td>AccessionNumber</td>
      <td>DICOMweb searchable text metadata value. Should be the same for all
slides with the same Study Instance UID.</td>
    </tr>
    <tr>
      <td><strong>SpecimenCollectionDate</strong></td>
      <td>StudyDate</td>
      <td>DICOMweb searchable metadata value. Should be the same for all slides
with the same Study Instance UID.</td>
    </tr>
    <tr>
      <td><strong>Patient Name</strong></td>
      <td>Patient Name</td>
      <td>DICOMweb searchable text metadata value. Should be the same for all
slides with the same Study Instance UID.</td>
    </tr>
    <tr>
      <td><strong>Patient ID</strong></td>
      <td>Patient ID</td>
      <td>DICOMweb searchable text metadata value. Should be the same for all
slides with the same Study Instance UID.</td>
    </tr>
    <tr>
      <td><strong>Requesting Physician</strong></td>
      <td>ReferringPhysicianName</td>
      <td>DICOMweb searchable text metadata value. Should be the same for all
slides with the same Study Instance UID. For non-clinical research
use cases replace with the name of laboratory or requesting
scientist.</td>
    </tr>
    <tr>
      <td><strong>Slide ID</strong></td>
      <td>ContainerIdentifier</td>
      <td>Type 1 Tag; Required for DICOM Conformance; Unique identifier for the
glass slide.</td>
    </tr>
    <tr>
      <td><strong>Material ID</strong></td>
      <td>SpecimenIdentifier</td>
      <td>Type 1 Tag; Required for DICOM Conformance; Clinic or lab identifier
for a specimen. </td>
    </tr>
    <tr>
      <td><strong>Specimen UID</strong></td>
      <td>SpecimenUID</td>
      <td>Type 1 Tag; Required for DICOM Conformance; DICOM UID for the
specimen.</td>
    </tr>
  </tbody>
</table>

## Appendix 2: Default IaC installed metadata mapping schema for Digital
Pathology DICOM

    {
        "DICOMSchemaDef":{
            "SOPClassUID_Name": "VL Microscopic Image Storage"
        },
        "0x00100010": {
            "Keyword": "PatientName",
            "Meta": "Patient Name"
        },
        "0x00100020": {
            "Keyword": "PatientID",
            "Meta": "Patient ID"
        },
        "0x00100030": {
            "Keyword": "PatientBirthDate",
            "Meta": "Patient DOB"
        },
        "0x00100040": {
            "Keyword": "PatientSex",
            "Meta": "Patient Sex"
        },
        "0x00080020": {
            "Keyword": "StudyDate",
            "Meta": "SpecimenCollectionDate"
        },
        "0x00080030": {
            "Keyword": "StudyTime",
            "Meta": "SpecimenCollectionTime"
        },
        "0x00080021": {
            "Keyword": "SeriesDate",
            "Meta": "SpecimenCollectionDate"
        },
        "0x00080031": {
            "Keyword": "SeriesTime",
            "Meta": "SpecimenCollectionTime"
        },
        "0x00101010": {
            "Keyword": "PatientAge",
            "Meta": "Patient Age on Collection Date"
        },
        "0x00400512": {
            "Keyword": "ContainerIdentifier",
            "Meta": "Slide ID"
        },
        "0x00081030": {
            "Keyword": "StudyDescription",
            "Meta": ["Test ID", "Test Name"],
            "Meta_Join": "-"
        },
        "0x00080080": {
            "Keyword": "InstitutionName",
            "Meta": "Institution Name"
        },
        "0x00081040": {
            "Keyword": "InstitutionalDepartmentName",
            "Meta": "Department"
        },
        "0x00080090": {
            "Keyword": "ReferringPhysicianName",
            "Meta": "Requesting Physician"
        },
        "0x00400560": {
            "Keyword": "SpecimenDescriptionSequence",
            "SQ": [
                {
                    "0x00400551": {
                        "Keyword": "SpecimenIdentifier",
                        "Meta": "Material ID"
                    },
                    "0x00400554": {
                        "Keyword": "SpecimenUID",
                        "Meta": "Specimen UID"
                    },
                    "0x00400600": {
                        "Keyword": "SpecimenShortDescription",
                        "Meta": "Specimen Description"
                    },
                    "0x00400602": {
                        "Keyword": "SpecimenDetailedDescription",
                        "Meta": "Specimen Modifier"
                    },
                    "0x00400610" : {
                        "Keyword" : "SpecimenPreparationSequence",
                        "SQ": [
                            {
                                "0x00400612" : {
                                    "Keyword": "SpecimenPreparationStepContentItemSequence",
                                    "SQ": [
                                        {
                                            "0x0040A160" : {
                                                "Keyword": "TextValue",
                                                "Meta": "Material Type"
                                            },
                                            "0x0040A040": {
                                                "Keyword": "ValueType",
                                                "Static_Value": "TEXT",
                                                "Conditional_On": "Material Type"
                                            },
                                            "0x0040A043" : {
                                                "Keyword":  "ConceptNameCodeSequence",
                                                "SEQ": {
                                                    "0x00080100": {
                                                        "Keyword": "CodeValue",
                                                        "VALUE_CHAR_LIMIT": "<=16",
                                                        "Meta": "Material Type"
                                                    },
                                                    "0x00080119": {
                                                        "Keyword": "LongCodeValue",
                                                        "VALUE_CHAR_LIMIT": ">16",
                                                        "Meta": "Material Type"
                                                    },
                                                    "0x00080102": {
                                                        "Keyword": "CodingSchemeDesignator",
                                                        "Static_Value": "99_WHO",
                                                        "Conditional_On": "Material Type"
                                                    },
                                                    "0x00080104": {
                                                        "Keyword": "CodeMeaning",
                                                        "Static_Value": "Material Type",
                                                        "Conditional_On": "Material Type"
                                                    }
                                                }
                                            }
                                        },

                                        {
                                            "0x0040A160" : {
                                                "Keyword": "TextValue",
                                                "Meta": "Specimen Type"
                                            },
                                            "0x0040A040": {
                                                "Keyword": "ValueType",
                                                "Static_Value": "TEXT",
                                                "Conditional_On": "Specimen Type"
                                            },
                                            "0x0040A043" : {
                                                "Keyword":  "ConceptNameCodeSequence",
                                                "SEQ": {
                                                    "0x00080100": {
                                                        "Keyword": "CodeValue",
                                                        "VALUE_CHAR_LIMIT": "<=16",
                                                        "Meta": "Specimen Type"
                                                    },
                                                    "0x00080119": {
                                                        "Keyword": "LongCodeValue",
                                                        "VALUE_CHAR_LIMIT": ">16",
                                                        "Meta": "Specimen Type"
                                                    },
                                                    "0x00080102": {
                                                        "Keyword": "CodingSchemeDesignator",
                                                        "Static_Value": "99_WHO",
                                                        "Conditional_On": "Specimen Type"
                                                    },
                                                    "0x00080104": {
                                                        "Keyword": "CodeMeaning",
                                                        "Static_Value": "Specimen Type",
                                                        "Conditional_On": "Specimen Type"
                                                    }
                                                }
                                            }
                                        },

                                        {
                                            "0x0040A160" : {
                                                "Keyword": "TextValue",
                                                "Meta": "Stain"
                                            },
                                            "0x0040A040": {
                                                "Keyword": "ValueType",
                                                "Static_Value": "TEXT",
                                                "Conditional_On": "Stain"
                                            },
                                            "0x0040A043" : {
                                                "Keyword":  "ConceptNameCodeSequence",
                                                "SEQ": {
                                                    "0x00080100": {
                                                        "Keyword": "CodeValue",
                                                        "VALUE_CHAR_LIMIT": "<=16",
                                                        "Meta": "Stain"
                                                    },
                                                    "0x00080119": {
                                                        "Keyword": "LongCodeValue",
                                                        "VALUE_CHAR_LIMIT": ">16",
                                                        "Meta": "Stain"
                                                    },
                                                    "0x00080102": {
                                                        "Keyword": "CodingSchemeDesignator",
                                                        "Static_Value": "99_WHO",
                                                        "Conditional_On": "Stain"
                                                    },
                                                    "0x00080104": {
                                                        "Keyword": "CodeMeaning",
                                                        "Static_Value": "Stain",
                                                        "Conditional_On": "Stain"
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            "0x0040A160" : {
                                                "Keyword": "TextValue",
                                                "Meta": "Block Code"
                                            },
                                            "0x0040A040": {
                                                "Keyword": "ValueType",
                                                "Static_Value": "TEXT",
                                                "Conditional_On": "Block Code"
                                            },
                                            "0x0040A043" : {
                                                "Keyword":  "ConceptNameCodeSequence",
                                                "SEQ": {
                                                    "0x00080100": {
                                                        "Keyword": "CodeValue",
                                                        "VALUE_CHAR_LIMIT": "<=16",
                                                        "Meta": "Block Code"
                                                    },
                                                    "0x00080119": {
                                                        "Keyword": "LongCodeValue",
                                                        "VALUE_CHAR_LIMIT": ">16",
                                                        "Meta": "Block Code"
                                                    },
                                                    "0x00080102": {
                                                        "Keyword": "CodingSchemeDesignator",
                                                        "Static_Value": "99_WHO",
                                                        "Conditional_On": "Block Code"
                                                    },
                                                    "0x00080104": {
                                                        "Keyword": "CodeMeaning",
                                                        "Static_Value": "Block Code",
                                                        "Conditional_On": "Block Code"
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            "0x0040A160" : {
                                                "Keyword": "TextValue",
                                                "Meta": "Specimen Code"
                                            },
                                            "0x0040A040": {
                                                "Keyword": "ValueType",
                                                "Static_Value": "TEXT",
                                                "Conditional_On": "Specimen Code"
                                            },
                                            "0x0040A043" : {
                                                "Keyword":  "ConceptNameCodeSequence",
                                                "SEQ": {
                                                    "0x00080100": {
                                                        "Keyword": "CodeValue",
                                                        "VALUE_CHAR_LIMIT": "<=16",
                                                        "Meta": "Specimen Code"
                                                    },
                                                    "0x00080119": {
                                                        "Keyword": "LongCodeValue",
                                                        "VALUE_CHAR_LIMIT": ">16",
                                                        "Meta": "Specimen Code"
                                                    },
                                                    "0x00080102": {
                                                        "Keyword": "CodingSchemeDesignator",
                                                        "Static_Value": "99_WHO",
                                                        "Conditional_On": "Specimen Code"
                                                    },
                                                    "0x00080104": {
                                                        "Keyword": "CodeMeaning",
                                                        "Static_Value": "Specimen Code",
                                                        "Conditional_On": "Specimen Code"
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        },

        "0x00080050": {
            "Keyword": "AccessionNumber",
            "Meta": "Case ID"
        },
        "0x00080051" : {
            "Keyword" : "IssuerOfAccessionNumberSequence",
            "SQ": {
                "0x00400031": {
                    "Keyword": "LocalNamespaceEntityID",
                    "Static_Value":  "Example Hospital"
                },
                "0x00400032": {
                    "Keyword": "UniversalEntityID",
                    "Static_Value":  "www.ExampleHospital.org"
                },
                "0x00400033": {
                    "Keyword": "UniversalEntityIDType",
                    "Static_Value":  "DNS"
                }

            }
        },
        "0x0020000D": {
            "Keyword": "StudyInstanceUID",
            "Meta": "StudyInstanceUID"
        },
        "0x22000005" :{
            "Keyword": "BarcodeValue",
            "Meta": "Bar Code Value"
        },
        "0x0008103E" :{
            "Keyword": "SeriesDescription",
            "Meta": ["Stain", "Specimen Modifier"],
            "Meta_Join": "-"
        },
        "0x00081084" :{
            "Keyword": "AdmittingDiagnosesCodeSequence",
            "SQ": [
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "DIAGNOSIS_CODE1"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "DIAGNOSIS_CODE1"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "ICD VERSION",
                        "Conditional_On": "DIAGNOSIS_CODE1"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "DIAGNOSIS_NAME1",
                        "Conditional_On": "DIAGNOSIS_CODE1"
                    }
                },
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "DIAGNOSIS_CODE2"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "DIAGNOSIS_CODE2"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "ICD VERSION",
                        "Conditional_On": "DIAGNOSIS_CODE2"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "DIAGNOSIS_NAME2",
                        "Conditional_On": "DIAGNOSIS_CODE2"
                    }
                },
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "DIAGNOSIS_CODE3"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "DIAGNOSIS_CODE3"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "ICD VERSION",
                        "Conditional_On": "DIAGNOSIS_CODE3"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "DIAGNOSIS_NAME3",
                        "Conditional_On": "DIAGNOSIS_CODE3"
                    }
                },
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "DIAGNOSIS_CODE4"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "DIAGNOSIS_CODE4"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "ICD VERSION",
                        "Conditional_On": "DIAGNOSIS_CODE4"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "DIAGNOSIS_NAME4",
                        "Conditional_On": "DIAGNOSIS_CODE4"
                    }
                },
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "SNOMED_CODE1"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "SNOMED_CODE1"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "SNOMED_VERSION",
                        "Conditional_On": "SNOMED_CODE1"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "SNOMED_DESCRIPTION1",
                        "Conditional_On": "SNOMED_CODE1"
                    }
                },
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "SNOMED_CODE2"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "SNOMED_CODE2"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "SNOMED_VERSION",
                        "Conditional_On": "SNOMED_CODE2"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "SNOMED_DESCRIPTION2",
                        "Conditional_On": "SNOMED_CODE2"
                    }
                },
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "SNOMED_CODE3"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "SNOMED_CODE3"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "SNOMED_VERSION",
                        "Conditional_On": "SNOMED_CODE3"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "SNOMED_DESCRIPTION3",
                        "Conditional_On": "SNOMED_CODE3"
                    }
                },
                {
                    "0x00080100" : {
                        "Keyword": "CodeValue",
                        "VALUE_CHAR_LIMIT": "<=16",
                        "Meta": "SNOMED_CODE4"
                    },
                    "0x00080119" : {
                        "Keyword": "LongCodeValue",
                        "VALUE_CHAR_LIMIT": ">16",
                        "Meta": "SNOMED_CODE4"
                    },
                    "0x00080102" : {
                        "Keyword": "CodingSchemeDesignator",
                        "Meta": "SNOMED_VERSION",
                        "Conditional_On": "SNOMED_CODE4"
                    },
                    "0x00080104" : {
                        "Keyword": "CodeMeaning",
                        "Meta": "SNOMED_DESCRIPTION4",
                        "Conditional_On": "SNOMED_CODE4"
                    }
                }
            ]
        }
    }
